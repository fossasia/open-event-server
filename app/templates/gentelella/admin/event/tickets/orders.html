{% extends 'gentelella/admin/event/tickets/tickets_base.html' %}

{% set active_side_page = "orders" %}

{% block head_css %}
    {{ super() }}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='admin/lib/datatables.net-bs/css/dataTables.bootstrap.min.css') }}"/>
    <style type="text/css">
        #orders-table .order-link {
            font-weight: 800;
            font-size: larger;
        }

        #orders-table .order-link::before {
            content: '#';
            font-weight: 800;
        }

        #orders-table .payment-via {
            font-weight: 600;
        }

        #orders-table .datetime {
            color: #9a9a9a;
        }

        #orders-table .label {
            font-size: 16px;
            padding: 5px;
            font-weight: 400;
        }

        #orders-table td {
            vertical-align: middle;
        }
    </style>
{% endblock %}

{% block inner_content %}
    <div id="toolbar-holder" style="display: none;">
        <div class="btn-group pull-left" data-toggle="buttons">
            <label class="btn btn-default active btn-responsive">
                <input type="radio" name="show_state" autocomplete="off" value="Completed" checked> {{ _("Completed") }}
            </label>
            <label class="btn btn-default btn-responsive">
                <input type="radio" name="show_state" autocomplete="off" value="Placed"> {{ _("Placed") }}
            </label>
            <label class="btn btn-default btn-responsive">
                <input type="radio" name="show_state" autocomplete="off" value="Pending"> {{ _("Pending") }}
            </label>
            <label class="btn btn-default btn-responsive">
                <input type="radio" name="show_state" autocomplete="off" value="Expired"> {{ _("Expired") }}
            </label>
            <label class="btn btn-default btn-responsive">
                <input type="radio" name="show_state" autocomplete="off" value="all"> {{ _("All") }}
            </label>
        </div>
    </div>

    <h3>{{ _("View Orders") }}</h3>
    <br>
    <table class="table with-datatable" id="orders-table">
        <thead>
        <tr>
            <th>
                #
            </th>
            <th>
                {{ _("Order") }}
            </th>
            <th>
                {{ _("Order Status") }}
            </th>
            <th>
                {{ _("Total Amount") }}
            </th>
            <th>
                {{ _("Qty") }}
            </th>
            <th>
                {{ _("Buyer / Registration Contact") }}
            </th>
            <th>
                {{ _("Action") }}
            </th>
        </tr>
        </thead>
        <tbody>
        {% for order in orders %}
            {% if order.status != "deleted" %}
                <tr>
                    <td></td>
                    <td>
                        <a href="{{ url_for('ticketing.view_order_after_payment', order_identifier=order.identifier) if order.status == 'completed' else url_for('ticketing.show_transaction_error', order_identifier=order.identifier) }}"
                           class="order-link">{{ order.get_invoice_number() }}</a> -
                        by {{ order.user.user_detail.fullname if order.user.user_detail and order.user.user_detail.fullname else order.user.email }}
                        <br>
                        {% if order.status == 'completed' %}
                            <span class="payment-via">Payment via {{ order.paid_via | capitalize }}</span>
                        {% endif %}
                        {% if order.status == 'completed' %}
                            <span class="datetime">{{ order.completed_at | datetime }} - {{ order.completed_at | humanize }}</span>
                        {% else %}
                            <span class="datetime">{{ order.created_at | datetime }} - {{ order.created_at | humanize }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if order.status == 'completed' %}
                            <span id="label-{{ order.identifier }}" class="label label-success">{{ order.status | capitalize }}</span>
                        {% elif order.status == 'pending' or order.status == 'initialized' %}
                            <span id="label-{{ order.identifier }}" class="label label-warning">{{ _("Pending") }}</span>
                        {% elif order.status == 'placed' %}
                            <span id="label-{{ order.identifier }}" class="label label-info">{{ order.status | capitalize }}</span>
                        {% else %}
                            <span id="label-{{ order.identifier }}" class="label label-danger">{{ order.status | capitalize }}</span>
                        {% endif %}

                    </td>
                    <td>{{ event.payment_currency | currency_symbol }}{{ order.amount | money }}</td>
                    <td>{{ order.get_tickets_count() }}</td>
                    <td>{{ order.user.email }}</td>
                    <td>
                        <div class="btn-group btn-group-xs" role="group">
                            {% if order.status != "cancelled" %}
                            <button data-toggle="tooltip" title="Cancel" data-url="{{ url_for('ticketing.cancel_order',order_identifier = order.identifier) }}" data-identifier="{{ order.identifier }}" class="btn btn-default cancel-order"><i class="fa fa-times fa-fw"></i></button>
                            {% endif %}
                            <button data-toggle="tooltip" title="Delete" data-url="{{ url_for('ticketing.delete_order',order_identifier = order.identifier) }}" data-identifier="{{ order.identifier }}" class="btn btn-default delete-order"><i class="fa fa-trash fa-fw"></i></button>
                        </div>
                    </td>
                </tr>
            {% endif %}
        {% endfor %}
        </tbody>
    </table>
{% endblock %}
{% block tail_js %}
    {{ super() }}
    <script src="{{ url_for('static', filename='admin/lib/datatables.net/js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ url_for('static', filename='admin/lib/datatables.net-bs/js/dataTables.bootstrap.min.js') }}"></script>
    <script type="text/javascript">

        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                var user_option = $("input[name=show_state]:checked").val();
                var state = data[2].trim() || 'pending';
                if (user_option === "all") {
                    return true;
                } else if (user_option === state) {
                    return true;
                }
                return false;
            }
        );

        var table = $('.with-datatable').DataTable({
            "dom": '<"row"<"toolbar col-md-12"<"pull-right"l>>>tip',
            "columnDefs": [
                {
                    "searchable": false,
                    "orderable": false,
                    "width": "3%",
                    "targets": 0
                },
                {"width": "40%", "targets": 1},
                {"width": "10%", "targets": 3}
            ],
            "order": [[1, 'asc']],
            "scrollX": true
        });

        $("div.toolbar").prepend($("#toolbar-holder").html());

        $("input[name=show_state]").change(function () {
            table.draw();
        });

        table.on('draw', function () {
            $('[data-toggle="tooltip"]').tooltip();
        });

        table.on('order.dt search.dt', function () {
            table.column(0, {search: 'applied', order: 'applied'}).nodes().each(function (cell, i) {
                cell.innerHTML = i + 1;
            });
        }).draw();

        $('.cancel-order').click(function(){
            var this_elem = $(this);
            var identifier = $(this).data('identifier');
            $.ajax({
                type: 'POST',
                url: $(this).data('url'),
                dataType: 'json'
            }).done(function (data) {
                if(data.status){
                    var prev_label = $('#label-' + identifier);
                    prev_label.attr('class','label label-danger');
                    prev_label.text('Cancelled');
                    this_elem.remove();
                }
            })
        });

        $('.delete-order').click(function(){
            var this_elem = $(this);
            $.ajax({
                type: 'POST',
                url: $(this).data('url'),
                dataType: 'json'
            }).done(function (data) {
                if(data.status){
                    this_elem.closest('tr').remove();
                    this_elem.remove();
                }
            })
        });

    </script>

{% endblock %}

